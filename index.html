<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    sendEmailVerification
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // 1) INIT
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    appId: "YOUR_APP_ID"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // 2) DOM HOOKS
  const emailEl = document.getElementById('email');
  const passEl  = document.getElementById('password');
  const signupBtn = document.getElementById('signup');
  const loginBtn  = document.getElementById('login');
  const logoutBtn = document.getElementById('logout');
  const authPanel = document.getElementById('auth');
  const debtForm  = document.getElementById('debt-form');

  // helper: show/hide panels
  function showApp(isAuthedAndVerified) {
    if (isAuthedAndVerified) {
      authPanel.style.display = 'none';
      debtForm.style.display  = 'block';
      logoutBtn.style.display = 'inline-block';
    } else {
      authPanel.style.display = 'block';
      debtForm.style.display  = 'none';
      logoutBtn.style.display = 'none';
    }
  }
  // start hidden until we know
  showApp(false);

  // 3) SIGN UP → send verification email
  signupBtn.addEventListener('click', async () => {
    const email = emailEl.value.trim();
    const pass  = passEl.value;
    if (!email || !pass) {
      alert('Enter email and password.');
      return;
    }
    signupBtn.disabled = true;
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await sendEmailVerification(cred.user);
      alert('Verification email sent. Check your inbox and verify before logging in.');
    } catch (e) {
      console.error(e);
      alert(e.message || 'Sign up failed.');
    } finally {
      signupBtn.disabled = false;
    }
  });

  // 4) LOG IN → block if not verified
  loginBtn.addEventListener('click', async () => {
    const email = emailEl.value.trim();
    const pass  = passEl.value;
    if (!email || !pass) {
      alert('Enter email and password.');
      return;
    }
    loginBtn.disabled = true;
    try {
      const cred = await signInWithEmailAndPassword(auth, email, pass);
      if (!cred.user.emailVerified) {
        await signOut(auth);
        alert('Please verify your email first (check inbox/spam).');
        return;
      }
      // onAuthStateChanged will flip the UI
    } catch (e) {
      console.error(e);
      alert(e.message || 'Login failed.');
    } finally {
      loginBtn.disabled = false;
    }
  });

  // 5) LOG OUT
  logoutBtn.addEventListener('click', async () => {
    try { await signOut(auth); } catch (e) { console.error(e); }
  });

  // 6) AUTH STATE GUARD
  onAuthStateChanged(auth, (user) => {
    const ok = !!user && !!user.emailVerified;
    showApp(ok);
  });
</script>
