<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Debt Tracker</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <h1>Debt Tracker</h1>

  <!-- AUTH PANEL -->
  <div id="auth">
    <input id="email" type="email" placeholder="Email" autocomplete="email" />
    <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
    <button id="signup" type="button">Sign Up</button>
    <button id="login" type="button">Log In</button>
    <button id="logout" type="button" style="display:none">Log Out</button>
  </div>

  <!-- DEBT FORM -->
  <form id="debt-form" autocomplete="off">
    <input type="text" id="debt-name" placeholder="Debt Name" required />
    <input type="number" id="original-amount" placeholder="Original Amount" step="0.01" />
    <input type="number" id="balance" placeholder="Current Balance" step="0.01" />
    <input type="number" id="amount-paid" placeholder="Amount Paid" step="0.01" />
    <input type="number" id="apr" placeholder="APR %" step="0.01" />
    <input type="number" id="min-payment" placeholder="Min Payment" step="0.01" />
    <input type="date" id="due-date" />
    <button type="submit">Add</button>
  </form>

  <!-- TABLE -->
  <table id="debt-table">
    <thead>
      <tr>
        <th>Name</th><th>Original</th><th>Balance</th><th>Paid</th>
        <th>APR</th><th>Min Pay</th><th>Due</th><th>% Paid</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <th>Totals</th>
        <th id="tot-original">$0.00</th>
        <th id="tot-balance">$0.00</th>
        <th id="tot-paid">$0.00</th>
        <th></th>
        <th id="tot-minpay">$0.00</th>
        <th colspan="3"></th>
      </tr>
    </tfoot>
  </table>

  <!-- Modular Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, sendEmailVerification
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, doc,
      getDocs, setDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ===== Firebase config (fill the 3 placeholders) =====
    const firebaseConfig = {
      apiKey: "AIzaSyDiFlAL9xN1MiFlvNGQ425anWXg8Ed32cc",
      authDomain: "REPLACE_ME.firebaseapp.com",
      projectId: "REPLACE_ME",
      appId: "REPLACE_ME"           // looks like: 1:1234567890:web:abcdef123456
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ===== DOM =====
    const $ = (sel) => document.querySelector(sel);
    const emailEl   = $('#email');
    const passEl    = $('#password');
    const signupBtn = $('#signup');
    const loginBtn  = $('#login');
    const logoutBtn = $('#logout');
    const authPanel = $('#auth');
    const debtForm  = $('#debt-form');
    const tbody     = document.querySelector('#debt-table tbody');
    const totOriginalEl = $('#tot-original');
    const totBalanceEl  = $('#tot-balance');
    const totPaidEl     = $('#tot-paid');
    const totMinPayEl   = $('#tot-minpay');
    const dueInput      = $('#due-date');

    // ===== Utils =====
    const fmt = (n) => isFinite(n) ? n.toLocaleString(undefined,{style:'currency',currency:'USD'}) : '$0.00';
    const pct = (n) => isFinite(n) ? `${n.toFixed(1)}%` : '0%';
    const todayISO = () => new Date().toISOString().slice(0,10);
    const escapeHtml = (s) => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

    // ===== State =====
    let debts = [];
    let user  = null;

    // ===== UI show/hide =====
    function showApp(authedAndVerified) {
      if (!authPanel || !debtForm || !logoutBtn) return;
      if (authedAndVerified) {
        authPanel.style.display = 'none';
        debtForm.style.display  = 'block';
        logoutBtn.style.display = 'inline-block';
      } else {
        authPanel.style.display = 'block';
        debtForm.style.display  = 'none';
        logoutBtn.style.display = 'none';
      }
    }

    // ===== Firestore I/O =====
    async function loadDebtsFromCloud(uid) {
      const snap = await getDocs(collection(db, `users/${uid}/debts`));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }
    async function saveDebtToCloud(uid, item) {
      const ref = item.id
        ? doc(db, `users/${uid}/debts/${item.id}`)
        : doc(collection(db, `users/${uid}/debts`));
      if (!item.id) item.id = ref.id;
      await setDoc(ref, item);
      return item;
    }
    async function deleteDebtFromCloud(uid, id) {
      await deleteDoc(doc(db, `users/${uid}/debts/${id}`));
    }

    // ===== LocalStorage (when logged out) =====
    const LOCAL_KEY = 'debts.v1';
    function loadFromLocal() {
      try { debts = JSON.parse(localStorage.getItem(LOCAL_KEY) || '[]'); }
      catch { debts = []; }
    }
    function saveToLocal() {
      localStorage.setItem(LOCAL_KEY, JSON.stringify(debts));
    }

    // ===== Render =====
    function render() {
      if (!tbody) return;
      tbody.innerHTML = '';

      let totOriginal = 0, totBalance = 0, totPaid = 0, totMin = 0;

      debts
        .slice()
        .sort((a,b) => (a.due || '').localeCompare(b.due || ''))
        .forEach((d, idx) => {
          totOriginal += d.original   || 0;
          totBalance  += d.balance    || 0;
          totPaid     += d.paid       || 0;
          totMin      += d.minPayment || 0;

          const percentPaid = d.original > 0 ? (100 * (d.paid || 0) / d.original) : 0;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(d.name || '')}</td>
            <td>${fmt(d.original)}</td>
            <td>${fmt(d.balance)}</td>
            <td>${fmt(d.paid)}</td>
            <td>${(d.apr || 0).toFixed(2)}</td>
            <td>${fmt(d.minPayment)}</td>
            <td>${d.due || ''}</td>
            <td>${pct(percentPaid)}</td>
            <td><button data-idx="${idx}" class="del">Delete</button></td>
          `;
          tbody.appendChild(tr);
        });

      if (totOriginalEl) totOriginalEl.textContent = fmt(totOriginal);
      if (totBalanceEl)  totBalanceEl.textContent  = fmt(totBalance);
      if (totPaidEl)     totPaidEl.textContent     = fmt(totPaid);
      if (totMinPayEl)   totMinPayEl.textContent   = fmt(totMin);

      tbody.querySelectorAll('button.del').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const i = Number(e.currentTarget.getAttribute('data-idx'));
          const item = debts[i];
          debts.splice(i, 1);
          if (user && item?.id) {
            await deleteDebtFromCloud(user.uid, item.id);
          } else {
            saveToLocal();
          }
          render();
        });
      });
    }

    // ===== Form =====
    function bindForm() {
      if (!debtForm) return;
      debtForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const item = {
          id: null,
          name: $('#debt-name')?.value.trim() || '',
          original: parseFloat($('#original-amount')?.value || '0') || 0,
          balance:  parseFloat($('#balance')?.value || '0') || 0,
          paid:     parseFloat($('#amount-paid')?.value || '0') || 0,
          apr:      parseFloat($('#apr')?.value || '0') || 0,
          minPayment: parseFloat($('#min-payment')?.value || '0') || 0,
          due: $('#due-date')?.value || todayISO(),
          createdAt: Date.now()
        };

        if (!($('#balance')?.value) && item.original >= 0 && item.paid >= 0) {
          const inferred = Math.max(item.original - item.paid, 0);
          item.balance = isFinite(inferred) ? inferred : 0;
        }

        debts.push(item);
        if (user) {
          await saveDebtToCloud(user.uid, item);
        } else {
          saveToLocal();
        }

        e.target.reset?.();
        if (dueInput) dueInput.value = todayISO();
        render();
      });
    }

    // ===== Auth Buttons =====
    function bindAuthButtons() {
      if (signupBtn) {
        signupBtn.addEventListener('click', async () => {
          const email = emailEl?.value.trim();
          const pass  = passEl?.value;
          if (!email || !pass) return alert('Enter email and password.');
          signupBtn.disabled = true;
          try {
            const cred = await createUserWithEmailAndPassword(auth, email, pass);
            await sendEmailVerification(cred.user);
            alert('Verification email sent. Verify before logging in.');
          } catch (e) {
            console.error(e);
            alert(e.message || 'Sign up failed.');
          } finally {
            signupBtn.disabled = false;
          }
        });
      }

      if (loginBtn) {
        loginBtn.addEventListener('click', async () => {
          const email = emailEl?.value.trim();
          const pass  = passEl?.value;
          if (!email || !pass) return alert('Enter email and password.');
          loginBtn.disabled = true;
          try {
            const cred = await signInWithEmailAndPassword(auth, email, pass);
            if (!cred.user.emailVerified) {
              await signOut(auth);
              alert('Please verify your email first (check inbox/spam).');
              return;
            }
          } catch (e) {
            console.error(e);
            alert(e.message || 'Login failed.');
          } finally {
            loginBtn.disabled = false;
          }
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try { await signOut(auth); } catch (e) { console.error(e); }
        });
      }
    }

    // ===== Startup =====
    document.addEventListener('DOMContentLoaded', () => {
      if (dueInput && !dueInput.value) dueInput.value = todayISO();
      bindAuthButtons();
      bindForm();
    });

    onAuthStateChanged(auth, async (u) => {
      user = (u && u.emailVerified) ? u : null;
      try {
        if (user) {
          debts = await loadDebtsFromCloud(user.uid);
        } else {
          loadFromLocal();
        }
      } catch (e) {
        console.warn('Load failed, using local.', e);
        loadFromLocal();
      }
      showApp(!!user);
      render();
    });
  </script>
</body>
</html>
